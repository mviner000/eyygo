<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.11"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-4">{{.Title}}</h1>
        <button id="toggleFormBtn"
                onclick="toggleUserForm()"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-4 inline-block">
            Create New User
        </button>
        <div id="userFormContainer" class="mb-8" style="display: none;">
            <div id="userForm"></div>
        </div>
        <div id="userList">
            <table class="w-full bg-white shadow-md rounded mb-4">
                <thead>
                    <tr>
                        <th class="py-2 px-4 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b border-gray-300">ID</th>
                        <th class="py-2 px-4 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b border-gray-300">Username</th>
                        <th class="py-2 px-4 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b border-gray-300">Email</th>
                        <th class="py-2 px-4 bg-gray-200 font-bold uppercase text-sm text-gray-600 border-b border-gray-300">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Users}}
                    <tr id="user-{{.ID}}">
                        <td class="py-2 px-4 border-b border-gray-300">{{.ID}}</td>
                        <td class="py-2 px-4 border-b border-gray-300">{{.Username}}</td>
                        <td class="py-2 px-4 border-b border-gray-300">{{.Email}}</td>
                        <td class="py-2 px-4 border-b border-gray-300">
                            <button hx-get="/admin/users/{{.ID}}"
                                    hx-target="#userForm"
                                    hx-swap="innerHTML"
                                    class="text-blue-500 hover:text-blue-700">
                                Edit
                            </button>
                            <button hx-delete="/admin/users/{{.ID}}"
                                    hx-confirm="Are you sure you want to delete this user?"
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) { this.closest('tr').remove(); showToast('User deleted successfully'); }"
                                    class="text-red-500 hover:text-red-700 ml-2">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg hidden"
         _="on show toggle .hidden until event hide">
    </div>
    <script>
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            toast.dispatchEvent(new Event('show'));
            setTimeout(function() {
                toast.dispatchEvent(new Event('hide'));
            }, 3000);
        }

        function toggleUserForm() {
            const formContainer = document.getElementById('userFormContainer');
            const toggleBtn = document.getElementById('toggleFormBtn');
            if (formContainer.style.display === 'none') {
                formContainer.style.display = 'block';
                toggleBtn.textContent = 'Hide Form';
                if (!document.getElementById('userForm').innerHTML) {
                    htmx.ajax('GET', '/admin/users/new', '#userForm');
                }
            } else {
                formContainer.style.display = 'none';
                toggleBtn.textContent = 'Create New User';
            }
            localStorage.setItem('userFormVisible', formContainer.style.display);
        }

        function handleFormResponse(event) {
            if (event.detail.successful) {
            const form = document.getElementById('userForm').querySelector('form');
            if (form) {
                form.reset();
            }
            showToast('User created successfully');
            toggleUserForm();
        } else {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.fields) {
                    Object.keys(response.fields).forEach(field => {
                        const errorElement = document.getElementById(`${field}-error`);
                        if (errorElement) {
                            errorElement.textContent = response.fields[field];
                        }
                    });
                }
            }
        }

        htmx.on("htmx:afterSwap", function(evt) {
            if (evt.detail.target.id === "userList") {
                showToast('Operation successful');
            }
        });

        htmx.on("htmx:responseError", function(evt) {
            let errorMessage = "An error occurred";
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                errorMessage = response.error || errorMessage;
            } catch (e) {
                console.error("Error parsing error response:", e);
            }
            alert("Error: " + errorMessage);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const formVisible = localStorage.getItem('userFormVisible');
            if (formVisible === 'block') {
                toggleUserForm();
            }
        });
    </script>
</body>
</html>